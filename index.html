<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR Shelf Designer</title>
    
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.3.0/model-viewer.min.js"></script>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            background-color: #f5f5f5;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* UI Panel Styles */
        #controls {
            background: white;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 10;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: flex-end;
            justify-content: center;
        }

        .input-group {
            display: flex;
            flex-direction: column;
        }

        label {
            font-size: 12px;
            font-weight: bold;
            color: #666;
            margin-bottom: 5px;
        }

        input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 80px;
        }

        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.2s;
        }

        button:hover {
            background-color: #0056b3;
        }

        /* AR Viewer Styles */
        #viewer-container {
            flex-grow: 1;
            position: relative;
            background: #eee;
        }

        model-viewer {
            width: 100%;
            height: 100%;
            background-color: #e0e0e0;
            --poster-color: #e0e0e0;
        }

        /* Loading Overlay */
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: none;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
        }
    </style>
</head>
<body>

    <div id="controls">
        <div class="input-group">
            <label>Height (cm)</label>
            <input type="number" id="hInput" value="180">
        </div>
        <div class="input-group">
            <label>Width (cm)</label>
            <input type="number" id="wInput" value="80">
        </div>
        <div class="input-group">
            <label>Depth (cm)</label>
            <input type="number" id="dInput" value="30">
        </div>
        <div class="input-group">
            <label>Shelves</label>
            <input type="number" id="sInput" value="4">
        </div>
        <button onclick="generateShelf()">Generate & Update AR</button>
    </div>

    <div id="viewer-container">
        <div id="loading">Generating 3D Model...</div>
        
        <model-viewer 
            id="shelf-viewer"
            src="" 
            ar 
            ar-modes="webxr scene-viewer quick-look" 
            camera-controls 
            shadow-intensity="1"
            environment-image="neutral" 
            auto-rotate>
        </model-viewer>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFExporter } from 'three/addons/exporters/GLTFExporter.js';

        // Initialize Three.js variables (offscreen)
        const scene = new THREE.Scene();
        // Wood Material
        const material = new THREE.MeshStandardMaterial({ 
            color: 0x8B5A2B, // Saddle Brown
            roughness: 0.6,
            metalness: 0.1
        });

        window.generateShelf = function() {
            const h = parseFloat(document.getElementById('hInput').value); // cm
            const w = parseFloat(document.getElementById('wInput').value); // cm
            const d = parseFloat(document.getElementById('dInput').value); // cm
            const shelvesCount = parseInt(document.getElementById('sInput').value);
            
            const thickness = 2; // 2cm thickness for wood
            
            // Show loading
            document.getElementById('loading').style.display = 'block';

            // Convert cm to meters for AR scale (1 unit = 1 meter usually in AR)
            // But Model Viewer handles units well. We will work in units = cm, then scale down if needed.
            // Actually, glTF defaults to meters. So let's convert inputs to meters.
            const hm = h / 100;
            const wm = w / 100;
            const dm = d / 100;
            const thickm = thickness / 100;

            // Clear previous mesh
            scene.clear();

            // 1. Create Side Panels (Left & Right)
            const sideGeo = new THREE.BoxGeometry(thickm, hm, dm);
            
            const leftPanel = new THREE.Mesh(sideGeo, material);
            leftPanel.position.set(-wm/2 + thickm/2, hm/2, 0);
            scene.add(leftPanel);

            const rightPanel = new THREE.Mesh(sideGeo, material);
            rightPanel.position.set(wm/2 - thickm/2, hm/2, 0);
            scene.add(rightPanel);

            // 2. Create Top and Bottom
            const hGeo = new THREE.BoxGeometry(wm - (thickm*2), thickm, dm);
            
            // Top
            const topPanel = new THREE.Mesh(hGeo, material);
            topPanel.position.set(0, hm - thickm/2, 0);
            scene.add(topPanel);

            // Bottom
            const bottomPanel = new THREE.Mesh(hGeo, material);
            bottomPanel.position.set(0, thickm/2, 0);
            scene.add(bottomPanel);

            // 3. Create Middle Shelves
            if (shelvesCount > 0) {
                // Calculate spacing
                // Available height for shelves is internal height
                const internalHeight = hm - (thickm * 2);
                // Divide by spaces (shelves + 1)
                const spacing = internalHeight / (shelvesCount + 1);

                for(let i = 1; i <= shelvesCount; i++) {
                    const shelf = new THREE.Mesh(hGeo, material);
                    // Position: Bottom thickness + (spacing * i)
                    const yPos = thickm + (spacing * i);
                    shelf.position.set(0, yPos, 0);
                    scene.add(shelf);
                }
            }

            // 4. Create Back Panel (Optional, but makes it sturdy)
            const backGeo = new THREE.BoxGeometry(wm, hm, 0.005); // Thin back
            const backPanel = new THREE.Mesh(backGeo, material);
            backPanel.position.set(0, hm/2, -dm/2);
            scene.add(backPanel);


            // EXPORT SCENE TO GLB BLOB
            const exporter = new GLTFExporter();
            exporter.parse(
                scene,
                function (result) {
                    if (result instanceof ArrayBuffer) {
                        const blob = new Blob([result], { type: 'application/octet-stream' });
                        const url = URL.createObjectURL(blob);
                        
                        // Update Model Viewer
                        const viewer = document.getElementById('shelf-viewer');
                        viewer.src = url;
                        
                        // Hide loading
                        document.getElementById('loading').style.display = 'none';
                    }
                },
                function (error) {
                    console.error('An error happened during export:', error);
                    document.getElementById('loading').style.display = 'none';
                },
                { binary: true } // Export as .glb (binary)
            );
        };

        // Generate default on load
        window.addEventListener('load', generateShelf);
    </script>
</body>
</html>
