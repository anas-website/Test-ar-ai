<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR Shelf - Debug Mode</title>
    
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.3.0/model-viewer.min.js"></script>

    <style>
        body { margin: 0; font-family: sans-serif; display: flex; flex-direction: column; height: 100vh; background: #f0f0f0; }
        
        /* STATUS LOG - To see errors */
        #status-log {
            background: #222;
            color: #0f0;
            font-family: monospace;
            padding: 10px;
            font-size: 12px;
            height: 60px;
            overflow-y: auto;
            border-bottom: 2px solid #555;
        }

        #controls { padding: 15px; background: white; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .full { grid-column: span 2; }
        input { width: 100%; box-sizing: border-box; padding: 8px; border: 1px solid #ccc; }
        label { font-size: 11px; font-weight: bold; color: #555; display: block; }
        
        button { 
            background: #007bff; color: white; border: none; padding: 12px; 
            font-size: 16px; border-radius: 6px; cursor: pointer;
        }
        button:disabled { background: #ccc; }

        #viewer-container { flex-grow: 1; position: relative; background: #e0e0e0; }
        model-viewer { width: 100%; height: 100%; }
    </style>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>
</head>
<body>

    <div id="status-log">System initializing...</div>

    <div id="controls">
        <div>
            <label>Shelf Height (cm)</label>
            <input type="number" id="hInput" value="100">
        </div>
        <div>
            <label>Shelf Width (cm)</label>
            <input type="number" id="wInput" value="80">
        </div>
        <div class="full">
            <label style="color:blue">Elevation from Floor (cm)</label>
            <input type="number" id="elInput" value="100">
        </div>
        <button class="full" id="genBtn" onclick="generateShelf()" disabled>Loading Libraries...</button>
    </div>

    <div id="viewer-container">
        <model-viewer 
            id="shelf-viewer" 
            src="" 
            ar 
            ar-modes="webxr scene-viewer quick-look" 
            ar-placement="floor"
            camera-controls 
            shadow-intensity="1"
            auto-rotate>
        </model-viewer>
    </div>

    <script type="module">
        // Helper to log messages to screen
        function log(msg, isError = false) {
            const el = document.getElementById('status-log');
            el.innerHTML += `<br>${isError ? '❌ ' : '✅ '}${msg}`;
            el.scrollTop = el.scrollHeight;
            if(isError) console.error(msg); else console.log(msg);
        }

        log("Starting script...");

        let THREE, GLTFExporter;

        try {
            // Import Three.js dynamically
            THREE = await import('three');
            log("Three.js loaded.");
            
            const ExporterModule = await import('three/addons/exporters/GLTFExporter.js');
            GLTFExporter = ExporterModule.GLTFExporter;
            log("GLTF Exporter loaded.");

            // Enable button
            document.getElementById('genBtn').disabled = false;
            document.getElementById('genBtn').innerText = "Generate Shelf";
            
            // Auto-generate first time
            setTimeout(window.generateShelf, 500);

        } catch (e) {
            log("CRITICAL ERROR: " + e.message, true);
            alert("Failed to load libraries. Check internet connection.");
        }

        // --- GENERATION LOGIC ---
        window.generateShelf = function() {
            if (!THREE || !GLTFExporter) {
                log("Libraries not ready yet.", true);
                return;
            }

            try {
                log("Building 3D Model...");
                
                const scene = new THREE.Scene();
                const material = new THREE.MeshStandardMaterial({ color: 0x8B5A2B }); // Wood color

                // Get Inputs
                const h = parseFloat(document.getElementById('hInput').value) / 100;
                const w = parseFloat(document.getElementById('wInput').value) / 100;
                const elevation = parseFloat(document.getElementById('elInput').value) / 100;
                const d = 0.3; // Depth fixed at 30cm for simplicity
                const thick = 0.02;

                // Function to add box
                function addBox(bx, by, bz, x, y, z) {
                    const geo = new THREE.BoxGeometry(bx, by, bz);
                    const mesh = new THREE.Mesh(geo, material);
                    // Y + Elevation to float it
                    mesh.position.set(x, y + elevation, z);
                    scene.add(mesh);
                }

                // Left Panel
                addBox(thick, h, d, -w/2 + thick/2, h/2, 0);
                // Right Panel
                addBox(thick, h, d, w/2 - thick/2, h/2, 0);
                // Top
                addBox(w - thick*2, thick, d, 0, h - thick/2, 0);
                // Bottom
                addBox(w - thick*2, thick, d, 0, thick/2, 0);
                // Back
                addBox(w, h, 0.005, 0, h/2, -d/2);

                log("Model built. Exporting...");

                // Export
                const exporter = new GLTFExporter();
                exporter.parse(scene, function (result) {
                    const blob = new Blob([result], { type: 'application/octet-stream' });
                    const url = URL.createObjectURL(blob);
                    
                    const viewer = document.getElementById('shelf-viewer');
                    viewer.src = url;
                    
                    log("Displaying in Viewer.");
                }, function(err) {
                    log("Export error: " + err, true);
                }, { binary: true });

            } catch (err) {
                log("Generation Error: " + err.message, true);
            }
        };
    </script>
</body>
</html>
