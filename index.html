<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR Shelf Designer v2</title>
    
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.3.0/model-viewer.min.js"></script>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <style>
        body { margin: 0; font-family: sans-serif; display: flex; flex-direction: column; height: 100vh; }
        #controls { background: white; padding: 15px; border-bottom: 1px solid #ccc; z-index: 10; display: flex; gap: 10px; flex-wrap: wrap; }
        input { width: 50px; padding: 5px; }
        button { background: #007bff; color: white; border: none; padding: 8px 15px; border-radius: 4px; }
        #viewer-container { flex-grow: 1; position: relative; background: #eee; }
        model-viewer { width: 100%; height: 100%; }
        
        /* Debug Console Styles */
        #debug-console {
            position: absolute; bottom: 0; left: 0; right: 0;
            background: rgba(0,0,0,0.8); color: lime; font-family: monospace;
            padding: 10px; font-size: 12px; height: 100px; overflow-y: auto;
            pointer-events: none; z-index: 100;
        }
    </style>
</head>
<body>

    <div id="controls">
        H: <input type="number" id="hInput" value="180">
        W: <input type="number" id="wInput" value="80">
        D: <input type="number" id="dInput" value="30">
        Shelves: <input type="number" id="sInput" value="4">
        <button onclick="generateShelf()">Update Model</button>
    </div>

    <div id="viewer-container">
        <model-viewer 
            id="shelf-viewer"
            src="" 
            ar 
            ar-modes="webxr scene-viewer quick-look" 
            camera-controls 
            shadow-intensity="1"
            auto-rotate>
            
            <button slot="ar-button" style="background-color: white; border-radius: 4px; border: none; position: absolute; top: 16px; right: 16px; height: 36px; padding: 0 16px;">
                ðŸ‘‹ Activate AR
            </button>
        </model-viewer>
        
        <div id="debug-console">System Ready...<br></div>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFExporter } from 'three/addons/exporters/GLTFExporter.js';

        // Custom Logger
        function log(msg) {
            const c = document.getElementById('debug-console');
            c.innerHTML += `> ${msg}<br>`;
            c.scrollTop = c.scrollHeight;
            console.log(msg);
        }

        const scene = new THREE.Scene();
        const material = new THREE.MeshStandardMaterial({ color: 0x8B5A2B });

        window.generateShelf = function() {
            log("Generating geometry...");
            const h = parseFloat(document.getElementById('hInput').value) / 100;
            const w = parseFloat(document.getElementById('wInput').value) / 100;
            const d = parseFloat(document.getElementById('dInput').value) / 100;
            const shelvesCount = parseInt(document.getElementById('sInput').value);
            const thick = 0.02;

            scene.clear();

            // Helper to make box
            function makeBox(bx, by, bz, x, y, z) {
                const geo = new THREE.BoxGeometry(bx, by, bz);
                const mesh = new THREE.Mesh(geo, material);
                mesh.position.set(x, y, z);
                scene.add(mesh);
            }

            // Sides
            makeBox(thick, h, d, -w/2 + thick/2, h/2, 0);
            makeBox(thick, h, d, w/2 - thick/2, h/2, 0);
            
            // Top/Bottom
            makeBox(w - thick*2, thick, d, 0, h - thick/2, 0);
            makeBox(w - thick*2, thick, d, 0, thick/2, 0);

            // Shelves
            if (shelvesCount > 0) {
                const space = (h - thick*2) / (shelvesCount + 1);
                for(let i=1; i<=shelvesCount; i++) {
                    makeBox(w - thick*2, thick, d, 0, thick + (space * i), 0);
                }
            }

            log("Exporting to GLB...");
            const exporter = new GLTFExporter();
            exporter.parse(scene, function (result) {
                const blob = new Blob([result], { type: 'application/octet-stream' });
                const url = URL.createObjectURL(blob);
                log("Blob URL created: " + url.split('/').pop());
                
                const viewer = document.getElementById('shelf-viewer');
                viewer.src = url;
                log("Model Viewer updated.");
            }, function(err) {
                log("Export Error: " + err);
            }, { binary: true });
        };

        // Listen for AR status
        const viewer = document.getElementById('shelf-viewer');
        viewer.addEventListener('ar-status', (event) => {
            log("AR Status: " + event.detail.status);
        });

        // Run once
        window.addEventListener('load', () => {
            log("Checking AR compatibility...");
            if (document.createElement('a').relList.supports('ar')) {
                log("Browser supports AR!");
            } else {
                log("Browser might not support standard AR links.");
            }
            generateShelf();
        });
    </script>
</body>
</html>
