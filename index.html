<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR Shelf - Wall Mount</title>
    
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.3.0/model-viewer.min.js"></script>

    <style>
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; display: flex; flex-direction: column; height: 100vh; background: #f5f5f5; }
        
        /* Debug Box */
        #ar-status {
            background: #ffecb3;
            color: #663c00;
            padding: 10px;
            font-size: 13px;
            text-align: center;
            border-bottom: 1px solid #e6cfa2;
        }

        #controls { padding: 15px; background: white; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; border-bottom: 1px solid #ddd; }
        .full { grid-column: span 2; }
        label { font-size: 11px; font-weight: bold; color: #666; display: block; margin-bottom: 4px; }
        input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        
        button { 
            background: #007bff; color: white; border: none; padding: 12px; 
            font-size: 16px; border-radius: 8px; font-weight: bold;
        }

        #viewer-container { flex-grow: 1; position: relative; background: #eee; }
        model-viewer { width: 100%; height: 100%; }

        /* Custom AR Button to ensure visibility */
        .ar-button {
            background-image: url(https://modelviewer.dev/shared-assets/icons/ic_view_in_ar_new_googblue_48dp.png);
            background-repeat: no-repeat;
            background-size: 20px 20px;
            background-position: 12px 50%;
            background-color: #fff;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            bottom: 20px;
            padding: 0px 16px 0px 40px;
            font-family: Roboto, Regular, Helvetica, sans-serif;
            font-size: 14px;
            color: #4285f4;
            height: 36px;
            line-height: 36px;
            border-radius: 18px;
            border: 1px solid #DADCE0;
            display: none; /* Hidden by default until AR is ready */
            z-index: 100;
        }
    </style>
    
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>
</head>
<body>

    <div id="ar-status">Checking AR capability...</div>

    <div id="controls">
        <div><label>Shelf Height (cm)</label><input type="number" id="hInput" value="80"></div>
        <div><label>Shelf Width (cm)</label><input type="number" id="wInput" value="60"></div>
        <div class="full">
            <label style="color:blue">Elevation from Floor (cm)</label>
            <input type="number" id="elInput" value="120">
        </div>
        <button class="full" onclick="generateShelf()">Update 3D Model</button>
    </div>

    <div id="viewer-container">
        <model-viewer 
            id="shelf-viewer" 
            src="" 
            ar 
            ar-modes="webxr scene-viewer quick-look" 
            ar-placement="floor"
            camera-controls 
            shadow-intensity="1" 
            auto-rotate>
            
            <button slot="ar-button" class="ar-button" id="ar-btn">
                View in your space
            </button>
        </model-viewer>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFExporter } from 'three/addons/exporters/GLTFExporter.js';

        const statusDiv = document.getElementById('ar-status');
        const viewer = document.getElementById('shelf-viewer');
        const arBtn = document.getElementById('ar-btn');

        // 1. CHECK AR COMPATIBILITY IMMEDIATELY
        function checkAR() {
            const isSecure = window.isSecureContext;
            const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);

            if (!isSecure) {
                statusDiv.innerHTML = "⚠️ <b>AR BLOCKED:</b> Page is not Secure (HTTPS).<br>Upload to Netlify or use Localhost.";
                statusDiv.style.background = "#ffcccb";
                return;
            }
            
            if (!isMobile) {
                statusDiv.innerHTML = "ℹ️ <b>Desktop Detected:</b> AR only works on Mobile.";
                return;
            }

            statusDiv.innerHTML = "✅ AR System Ready. Generating model...";
            statusDiv.style.background = "#d4edda";
        }

        // 2. GENERATE MODEL
        window.generateShelf = function() {
            const scene = new THREE.Scene();
            const material = new THREE.MeshStandardMaterial({ color: 0x8B5A2B });

            const h = parseFloat(document.getElementById('hInput').value) / 100;
            const w = parseFloat(document.getElementById('wInput').value) / 100;
            const elevation = parseFloat(document.getElementById('elInput').value) / 100;
            const d = 0.3; 
            const thick = 0.02;

            function addBox(bx, by, bz, x, y, z) {
                const geo = new THREE.BoxGeometry(bx, by, bz);
                const mesh = new THREE.Mesh(geo, material);
                mesh.position.set(x, y + elevation, z);
                scene.add(mesh);
            }

            // Build Shelf
            addBox(thick, h, d, -w/2 + thick/2, h/2, 0);
            addBox(thick, h, d, w/2 - thick/2, h/2, 0);
            addBox(w - thick*2, thick, d, 0, h - thick/2, 0);
            addBox(w - thick*2, thick, d, 0, thick/2, 0);
            addBox(w, h, 0.005, 0, h/2, -d/2);

            // Export
            const exporter = new GLTFExporter();
            exporter.parse(scene, function (result) {
                const blob = new Blob([result], { type: 'application/octet-stream' });
                const url = URL.createObjectURL(blob);
                
                viewer.src = url;
                
                // FORCE SHOW AR BUTTON ONCE MODEL IS LOADED
                setTimeout(() => {
                    if (viewer.canActivateAR) {
                        arBtn.style.display = 'block';
                        statusDiv.innerHTML = "✅ AR Ready. Tap 'View in your space'";
                    } else {
                        statusDiv.innerHTML = "⚠️ Model loaded, but browser says AR unavailable.";
                    }
                }, 1000);

            }, { binary: true });
        };

        checkAR();
        // Delay generation slightly to ensure Three.js is parsed
        setTimeout(generateShelf, 1000);
    </script>
</body>
</html>
